<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Google Pay API for Web</title>
    <style>
      #payment-data-container {
        font-family: monospace;
        white-space: pre-wrap;
        border: 1px solid #ccc;
        padding: 10px;
        margin-top: 10px;
      }

      #environment-selector {
        margin-bottom: 10px;
      }
    </style>
</head>

<body>
    <p>Demo merchant checkout page with a Google Pay button (direct)</p>
    <div id="environment-selector">
      <label for="environment">Environment:</label>
      <select id="environment">
        <option value="PRODUCTION" selected>PRODUCTION</option>
        <option value="TEST">TEST</option>
      </select>
    </div>
    <div id="gpay-container"></div>
    <div id="payment-data-container">Click the Google Pay button and complete a transaction to see the response here...</div>    
    <hr/>
    <div id="user-agent"></div>
    <script async src="https://pay.google.com/gp/p/js/pay.js" onload="onGooglePayLoaded()"></script>
    <script type="text/javascript">
        const GPAY_BUTTON_CONTAINER_ID = 'gpay-container';

        const merchantInfo = {
            merchantId: '14697717800897553235',
            merchantName: '4242.cards (direct)',
        };

        const baseGooglePayRequest = {
            apiVersion: 2,
            apiVersionMinor: 0,
            allowedPaymentMethods: [
                {
                    type: 'CARD',
                    parameters: {
                        allowedAuthMethods: ['PAN_ONLY', 'CRYPTOGRAM_3DS'],
                        allowedCardNetworks: ['AMEX', 'DISCOVER', 'INTERAC', 'JCB', 'MASTERCARD', 'VISA'],
                    },
                     tokenizationSpecification: {
                        type: 'DIRECT',
                        parameters: {
                            'protocolVersion': 'ECv2',
                            // 4242.cards
                            'publicKey': 'BLW5SD3ReB61JgxNeKyXNHIPVbknrmwKzIu8BfQZeQ3v4i4Z9q5uB3oHs+Dg4DvJQ09JVwgDe0XORMfx8A9ZaPw='
                        }
                    },
                },
            ],
            merchantInfo,
        };

        Object.freeze(baseGooglePayRequest);

        let paymentsClient = null;

        function getGooglePaymentsClient() {           
            if (paymentsClient === null) {
                const environment = document.getElementById('environment').value;
                paymentsClient = new google.payments.api.PaymentsClient({                 
                    environment: environment,
                    merchantInfo,
                });
            }

            return paymentsClient;
        }

        const deepCopy = obj => JSON.parse(JSON.stringify(obj));

        function renderGooglePayButton() {            
            const button = getGooglePaymentsClient().createButton({             
                onClick: onGooglePaymentButtonClicked,
            });            
            document.getElementById(GPAY_BUTTON_CONTAINER_ID).appendChild(button);
        }

        function onGooglePayLoaded() {
            document.getElementById('user-agent').innerHTML= window.navigator.userAgent;

            const environmentDropdown = document.getElementById('environment');
            environmentDropdown.addEventListener('change', () => {
                paymentsClient = null;
                document.getElementById(GPAY_BUTTON_CONTAINER_ID).innerHTML = '';
                loadAndRenderButton();
            });

            loadAndRenderButton();
        }

        function loadAndRenderButton() {
            const req = deepCopy(baseGooglePayRequest);
            getGooglePaymentsClient()
                .isReadyToPay(req)
                .then(function (res) {
                    if (res.result) {
                        renderGooglePayButton();
                    } else {
                        //console.log('Google Pay is not ready for this user.');
                        renderGooglePayButton();
                    }
                })
                .catch(console.error);
        }

        function onGooglePaymentButtonClicked() {
            const req = {
                ...deepCopy(baseGooglePayRequest),
                recurringTransactionInfo: {
                    "currencyCode": "EUR",
                    "countryCode": "DE",
                    "transactionId": "example-transaction-id",
                    "tokenUpdateUrl": "https://bunpay.app/google-pay-lcm-listener/14697717800897553235",
                    "billingAgreement": "Example localized billing agreement and terms.",
                    "immediateTotalPrice": "50.00",
                    "recurrenceItems": [
                        {
                            "billingInitialDateTime": "2026-01-08T08:00:00Z",
                            "label": "Video Streaming Monthly Subscription",
                            "price": "50.00",
                            "priceStatus": "FINAL",
                            "recurrencePeriod": "MONTH",
                            "recurrencePeriodCount": 1
                        }
                    ]
                }
            };

            console.log('onGooglePaymentButtonClicked', req);

            getGooglePaymentsClient()
                .loadPaymentData(req)
                .then(function (res) {
                    document.getElementById('payment-data-container').innerHTML = JSON.stringify(res, null, 2);
                    paymentToken = res.paymentMethodData.tokenizationData.token;
                })
                .catch(console.error);
        }

    </script>
</body>
</html>